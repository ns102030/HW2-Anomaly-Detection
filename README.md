# HW2 — Overlapping Sliding Windows Anomaly Detection

**Dataset:** `AG_NO3_fill_cells_remove_NAN-2.csv` (columns: `Date`, `NO3N`, `Student_Flag`)

## Method
- Fixed-size, overlapping sliding window with step size = 1.
- At each step, compute the **q-percentile** threshold \(T_i\) from the values **inside the current window** using:
  ```python
  np.percentile(window, q, method="linear")
  ```
- **One-sided upper-tail rule:** label point \(x_j\) (the newly added index for window *i*) as anomaly if \(x_j \ge T_i\).
- **Labeling policy:** only the newly added point per window is labeled (the first label appears at index \(W-1\)).

## Chosen Hyperparameters
- **Window size (W):** **600**
  - Balance between responsiveness to regime shifts and robust estimation of the upper tail.
  - Shorter windows (< 500) raised false positives; longer windows (> 1000) missed shorter spikes.
- **Percentile (q):** **90th**
  - Provides a good trade-off: detects most ground-truth spikes while keeping normal-accuracy high.

## Metrics (evaluated where predictions exist; i.e., indices ≥ W-1)
Using the dataset's `Student_Flag` as per-point ground truth:

- **TP:** 104  
- **FP:** 4399  
- **FN:** 34  
- **TN:** 25604  
- **P = TP + FN:** 138  
- **N = TN + FP:** 30003  

- **Normal accuracy = TN / N:** **85.34%**  
- **Anomaly accuracy = TP / P:** **75.36%**

**Target satisfaction:** Normal ≥ 80% , Anomaly ≥ 75% 

> Note: The assignment mentions “77 anomaly events total.” The provided CSV includes a per-point label `Student_Flag` with 141 positives across the full series. I treat `Student_Flag` as ground-truth for evaluation, which may mark multiple points within a single event. This aligns with per-sample scoring required for TP/FP/FN/TN.

## Figure
See `anomaly_plot_W600_q90.png` (generated by the script). Predicted anomalies (dots) and ground-truth anomalies (crosses) are overlaid on the time series.

## Design Choices
- **One-sided threshold** (upper tail) because nitrate anomalies present as positive spikes.
- **Label-only-new-point** policy to avoid leakage from future windows and to meet the “adaptive thresholding” requirement.
- NaNs: not present in the provided cleaned file; no additional filtering needed.
- Percentiles: computed with `numpy.percentile(..., method="linear")` per spec.

## How to Run
```bash
python hw2_sliding_window_anomaly.py
```
This will print metrics and save the plot as `anomaly_plot_W600_q90.png` in the working directory.

## Possible Extensions
- Add a lower-tail detector (two-sided) if negatives are relevant and tune two percentiles separately.
- Use rolling-window quantiles (e.g., via `pandas.Series.rolling().quantile`) for speed, while matching NumPy's `"linear"` interpolation.
- Simple de-duplication of contiguous anomaly runs to convert point-level to event-level scoring.
